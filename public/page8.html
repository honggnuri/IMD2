<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sejong Bloom - ê½ƒ ë§Œë“¤ê¸°</title>
    <link rel="stylesheet" href="styleflower.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
</head>

<body>
    <div class="step2box">
        <div class="img_container">
            <img src="/assets/phone10.jpg" alt="background">
        </div>
        <div class="step2-container">
            <div class="step2-header">
                <p class="step-subtitle" id="step2-sub-msg">ë¡œë”© ì¤‘...</p>
                <h2 class="main-question">ê½ƒì€ ì–´ë–»ê²Œ ìƒê²¼ì„ê¹Œ?</h2>
                <p class="step-subtitle-guide"> ëª¨ì–‘ê³¼ ìƒ‰ì„ ê³¨ë¼ ê½ƒì„ ë§Œë“¤ì–´ë³´ì! </p>
            </div>

            <div class="controls-wrapper">
                <div class="palette-row">
                    <span class="control-label" style="font-family: 'UhBeeZIGLE';">ëª¨ì–‘ (Shape)</span>
                    <div id="flower-palette-container" class="scroll-palette"></div>
                </div>

                <div class="palette-row">
                    <span class="control-label" style="font-family: 'UhBeeZIGLE';">ìƒ‰ìƒ (Color)</span>
                    <div id="color-palette" class="scroll-palette"></div>
                </div>
            </div>

            <div class="canvas-wrapper">
                <canvas id="c"></canvas>
                <div id="delete-zone" class="hidden">
                    <div class="trash-icon-bg"></div>
                </div>
            </div>

            <button class="finish-btn" onclick="saveAndMove()">ì™„ì„±í•˜ê¸°</button>
        </div>
    </div>

    <script>
        /* ============================================================
           1. ì‚¬ìš©ì ì •ë³´ ë¡œë“œ (localStorage ì „í™˜)
        ============================================================ */
        const storedName = localStorage.getItem('userName') || "í…ŒìŠ¤íŠ¸";
        const storedDistrict = localStorage.getItem('userDistrict') || "dodam";

        const districtNames = {
            'eojindong': 'ì–´ì§„ë™', 'dodam': 'ë„ë‹´ë™', 'areum': 'ì•„ë¦„ë™',
            'hamildong': 'í•œì†”ë™', 'naseongdong': 'ë‚˜ì„±ë™', 'bangok_jiphyeon': 'ë°˜ê³¡Â·ì§‘í˜„ë™',
            'jochiwon': 'ì¡°ì¹˜ì›ì', 'jeonui_myeon': 'ì „ì˜ë©´', 'yeonseomyeon': 'ì—°ì„œë©´',
            'bugangmyeon': 'ë¶€ê°•ë©´', 'geumnammyeon': 'ê¸ˆë‚¨ë©´', 'yeongimyeon': 'ì—°ê¸°ë©´',
            'janggunmyeon': 'ì¥êµ°ë©´', 'yeondongmyeon': 'ì—°ë™ë©´', 'otherarea': 'ê¸°íƒ€ ì§€ì—­'
        };

        const districtKr = districtNames[storedDistrict] || "ì„¸ì¢…ì‹œ";
        document.getElementById('step2-sub-msg').innerText = `${districtKr}ì—ì„œ ì˜¨ ${storedName}(ì´)ì˜`;

        const colorList = ['#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#FF6B6B', '#4DABF7', '#FFD43B', '#69DB7C', '#FCC2D7'];

        const districtShapes = {
            'eojindong': ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7'],
            'dodam': ['F1', 'F2', 'F3', 'F8', 'F9', 'F10', 'F11'],
            'areum': ['F1', 'F2', 'F3', 'F12', 'F13', 'F14', 'F15'],
            'hamildong': ['F1', 'F2', 'F3', 'F16', 'F17', 'F18', 'F19'],
            'naseongdong': ['F1', 'F2', 'F3', 'F20', 'F21', 'F22', 'F23'],
            'bangok_jiphyeon': ['F1', 'F2', 'F3', 'F24', 'F25', 'F26', 'F27'],
            'jochiwon': ['F1', 'F2', 'F3', 'F28', 'F29', 'F30', 'F31'],
            'jeonui_myeon': ['F1', 'F2', 'F3', 'F15', 'F30', 'F32', 'F33'],
            'yeonseomyeon': ['F1', 'F2', 'F3', 'F6', 'F8', 'F13', 'F34'],
            'bugangmyeon': ['F1', 'F2', 'F3', 'F35', 'F36', 'F37', 'F38'],
            'geumnammyeon': ['F1', 'F2', 'F3', 'F14', 'F26', 'F36', 'F39'],
            'yeongimyeon': ['F1', 'F2', 'F3', 'F32', 'F40', 'F41', 'F42'],
            'janggunmyeon': ['F1', 'F2', 'F3', 'F13', 'F43', 'F44', 'F45'],
            'yeondongmyeon': ['F1', 'F2', 'F3', 'F22', 'F36', 'F44', 'F46'],
            'otherarea': ['F1', 'F2', 'F3', 'F11', 'F35', 'F47', 'F48']
        };

        const myShapes = districtShapes[storedDistrict] || ['F1', 'F2', 'F3'];
        let currentSelectedColor = colorList[0];

        /* ============================================================
           2. ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        ============================================================ */
        const canvas = new fabric.Canvas('c', { preserveObjectStacking: true });
        canvas.backgroundColor = 'transparent';

        function moveSelectedToFront(e) {
            if (e.selected && e.selected.length > 0) {
                e.selected.forEach(obj => canvas.bringToFront(obj));
                canvas.renderAll();
            }
        }
        canvas.on('selection:created', moveSelectedToFront);
        canvas.on('selection:updated', moveSelectedToFront);

        window.onload = function () {
            resizeCanvas();
            initColorPalette();
            generatePalette(myShapes);
        };

        window.addEventListener('resize', resizeCanvas);

        function resizeCanvas() {
            const wrapper = document.querySelector('.canvas-wrapper');
            if (wrapper) {
                const size = wrapper.clientWidth;
                canvas.setWidth(size);
                canvas.setHeight(size);
                canvas.renderAll();
            }
        }

        /* ============================================================
           3. íŒ”ë ˆíŠ¸ UI ë¡œì§
        ============================================================ */
        function initColorPalette() {
            const container = document.getElementById('color-palette');
            container.innerHTML = '';
            colorList.forEach((color, idx) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn';
                if (idx === 0) btn.classList.add('active');
                btn.style.backgroundColor = color;
                btn.onclick = () => selectColor(btn, color);
                container.appendChild(btn);
            });
        }

        function selectColor(btn, color) {
            currentSelectedColor = color;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                applyColor(activeObj, color);
                canvas.renderAll();
            }
            updateShapeButtons(color);
        }

        async function generatePalette(shapes) {
            const container = document.getElementById('flower-palette-container');
            container.innerHTML = '';
            for (let shape of shapes) {
                const filePath = `assets/${shape}.svg`;
                try {
                    const res = await fetch(filePath);
                    if (!res.ok) throw new Error('SVG Load Fail');
                    let svgText = await res.text();
                    const btn = document.createElement('div');
                    btn.className = 'shape-btn';
                    btn.dataset.svg = svgText;
                    btn.dataset.type = shape;
                    btn.innerHTML = svgText.replace(/fill="[^"]*"/g, `fill="${currentSelectedColor}"`);
                    btn.onclick = () => addShapeToCanvas(shape, currentSelectedColor);
                    container.appendChild(btn);
                } catch (e) { console.warn(e); }
            }
        }

        function updateShapeButtons(color) {
            document.querySelectorAll('.shape-btn').forEach(btn => {
                const svg = btn.dataset.svg;
                if (svg) btn.innerHTML = svg.replace(/fill="[^"]*"/g, `fill="${color}"`);
            });
        }

        /* ============================================================
           4. ê°ì²´ ì¶”ê°€ ë° ì‚­ì œ ë¡œì§
        ============================================================ */
        function addShapeToCanvas(type, color) {
            fabric.loadSVGFromURL(`assets/${type}.svg`, (objects, options) => {
                const obj = fabric.util.groupSVGElements(objects, options);
                applyColor(obj, color);
                const canvasWidth = canvas.getWidth();
                const initialScale = (canvasWidth * 0.3) / Math.max(obj.width, obj.height);
                const center = canvas.getCenter();

                obj.set({
                    left: center.left, top: center.top,
                    originX: 'center', originY: 'center',
                    lockUniScaling: true,
                    snapAngle: 30,
                    cornerColor: 'rgba(0,0,0,0.5)',
                    transparentCorners: false
                });

                obj.setControlsVisibility({ mt: false, mb: false, ml: false, mr: false });
                obj.userColor = color;
                obj.type = type;

                canvas.add(obj);
                canvas.setActiveObject(obj);
                canvas.bringToFront(obj);

                obj.animate('scaleX', initialScale, { duration: 400, onChange: canvas.renderAll.bind(canvas), easing: fabric.util.ease.easeOutBack });
                obj.animate('scaleY', initialScale, { duration: 400, easing: fabric.util.ease.easeOutBack });
            });
        }

        function applyColor(obj, color) {
            obj.userColor = color;
            if (obj.isType('group')) {
                obj.getObjects().forEach(o => { if (o.fill !== 'none') o.set('fill', color); });
            } else { obj.set('fill', color); }
        }

        const deleteZone = document.getElementById('delete-zone');
        canvas.on('object:moving', (e) => {
            deleteZone.classList.remove('hidden');
            if (e.target.top > canvas.getHeight() * 0.8) {
                deleteZone.classList.add('delete-active');
                e.target.opacity = 0.5;
            } else {
                deleteZone.classList.remove('delete-active');
                e.target.opacity = 1;
            }
        });

        canvas.on('mouse:up', () => {
            const obj = canvas.getActiveObject();
            deleteZone.classList.add('hidden');
            deleteZone.classList.remove('delete-active');
            if (obj && obj.top > canvas.getHeight() * 0.8) {
                canvas.remove(obj);
                canvas.discardActiveObject();
                canvas.renderAll();
            }
        });

/* ============================================================
   5. ì €ì¥ ë° ì •ê·œí™” (ìœ ë‹ˆí‹° ë° ì •ì› í˜¸í™˜ ë²„ì „)
============================================================ */
async function saveAndMove() {
    canvas.discardActiveObject();
    canvas.renderAll();

    const objects = canvas.getObjects();
    if (objects.length === 0) {
        alert('ê½ƒì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”!');
        return;
    }

    /* ============================================================
       1. ê½ƒ ì˜ì—­(Bounding Box) ê³„ì‚°
    ============================================================ */
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

    objects.forEach(obj => {
        const coords = obj.aCoords;
        for (let key in coords) {
            const p = coords[key];
            if (p.x < minX) minX = p.x;
            if (p.y < minY) minY = p.y;
            if (p.x > maxX) maxX = p.x;
            if (p.y > maxY) maxY = p.y;
        }
    });

    const flowerWidth = maxX - minX;
    const flowerHeight = maxY - minY;

    /* ============================================================
       2. ğŸ‘‰ 1:1 ì •ë°©í˜• ì˜ì—­ ë§Œë“¤ê¸° (ì¤‘ì•™ ì •ë ¬)
    ============================================================ */
    const squareSize = Math.max(flowerWidth, flowerHeight);

    const squareLeft = minX + flowerWidth / 2 - squareSize / 2;
    const squareTop  = minY + flowerHeight / 2 - squareSize / 2;

    /* ============================================================
       3. Unity / ì •ì›ìš© ì •ê·œí™” ë°ì´í„°
    ============================================================ */
    const normalizeRatio = 1.0 / squareSize;
    const centerX = minX + flowerWidth / 2;
    const bottomY = maxY;

    const unityDataList = objects.map((o, index) => ({
        prefabName: o.type || 'petal_prefab',
        color: o.userColor || '#FF9AA2',
        posX: parseFloat(((o.left - centerX) * normalizeRatio).toFixed(6)),
        posY: parseFloat(((bottomY - o.top) * normalizeRatio).toFixed(6)),
        scaleX: parseFloat((o.scaleX * normalizeRatio).toFixed(6)),
        scaleY: parseFloat((o.scaleY * normalizeRatio).toFixed(6)),
        rotation: -o.angle,
        sortOrder: index
    }));

    /* ============================================================
       4. âœ… í° ë°°ê²½ ê¹”ê³  â†’ 1:1 ì •ë°©í˜•ìœ¼ë¡œ ìº¡ì²˜
    ============================================================ */
    const prevBg = canvas.backgroundColor;
    canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));

    const flowerImageUrl = canvas.toDataURL({
        format: 'png',
        multiplier: 2,
        left: squareLeft,
        top: squareTop,
        width: squareSize,
        height: squareSize
    });

    canvas.setBackgroundColor(prevBg, canvas.renderAll.bind(canvas));

    /* ============================================================
       5. ì„œë²„ ì „ì†¡ ë°ì´í„°
    ============================================================ */
    const finalData = {
        userName: storedName,
        location: storedDistrict,
        unityData: unityDataList,
        previewImage: flowerImageUrl
    };

    const finishBtn = document.querySelector('.finish-btn');
    if (finishBtn) {
        finishBtn.disabled = true;
        finishBtn.innerText = "ì €ì¥ ì¤‘...";
    }

    try {
        const response = await fetch('http://15.134.86.182:3000/upload-flower', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                location: storedDistrict,
                image: flowerImageUrl,
                userName: storedName
            })
        });

        if (!response.ok) throw new Error('ì„œë²„ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨');

        localStorage.setItem('flowerData', JSON.stringify(finalData));
        window.location.href = 'page9.html';

    } catch (error) {
        console.error("âŒ ì €ì¥ ì‹¤íŒ¨:", error);
        alert("ì„œë²„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

        if (finishBtn) {
            finishBtn.disabled = false;
            finishBtn.innerText = "ì™„ì„±í•˜ê¸°";
        }
    }
}

    </script>
</body>

</html>