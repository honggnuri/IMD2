<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sejong Bloom - 완성</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styleflower.css">
    <style>
        /* 기존 CSS 규격 유지 */
        #watering-canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
        }

        #final-result {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            background: white;
        }
        
        canvas { display: block; }

        /* 상단 문구(#instructions) 제거됨 */
    </style>
</head>
<body>

    <div class="container">
        <div class="img_container">
            <img src="/public/assets/phone10.jpg" alt="background">
        </div>

        <div id="watering-canvas-container"></div>

        <div id="final-result">
            <div class="img_container">
                <img src="/public/assets/phone11.jpg"> 
            </div>
            <button class="next-btn" onclick="location.href='/index.html'">우와!</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DragControls } from 'three/addons/controls/DragControls.js';

        const container = document.querySelector('.container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
        camera.position.set(0, 1, 10);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(width, height);
        document.getElementById('watering-canvas-container').appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 2.5));

        // 1. [데이터 연동] 페이지 7 꽃 이미지 로드
        const savedData = JSON.parse(localStorage.getItem('userFlower'));
        let flower;

        if (savedData && savedData.image) {
            const texture = new THREE.TextureLoader().load(savedData.image);
            flower = new THREE.Mesh(
                new THREE.PlaneGeometry(6, 6),
                new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide })
            );
        } else {
            flower = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 32), new THREE.MeshStandardMaterial({ color: 0xff6b6b }));
        }
        flower.position.set(0, -1, 0);
        scene.add(flower);

        // 2. 물뿌리개 설정
        let canGroup = new THREE.Group();
        scene.add(canGroup);

        const spoutHelper = new THREE.Mesh(
            new THREE.SphereGeometry(0.1, 8, 8),
            new THREE.MeshBasicMaterial({ color: 0xffcc00, transparent: true, opacity: 0 })
        );
        spoutHelper.position.set(1.8, 0.5, 0); 
        canGroup.add(spoutHelper);

        const loader = new GLTFLoader();
        let targetRotZ = 0; 
        let targetRotY = 0;
        let isWatering = false;

        loader.load('./assets/Watering_Can.glb', (gltf) => {
            const model = gltf.scene;
            // 물뿌리개 크기 고정 (0.05)
            model.scale.set(0.05, 0.05, 0.05);
            canGroup.add(model);
            
            // [수정] 초기 위치를 우측 상단으로 변경
            canGroup.position.set(4, 4, 0);
            
            const controls = new DragControls([canGroup], camera, renderer.domElement);
            controls.transformGroup = true;
        });

        // 3. 파티클 시스템
        const count = 500;
        const geom = new THREE.BufferGeometry();
        const pos = new Float32Array(count * 3);
        const vel = new Float32Array(count);

        for (let i = 0; i < count; i++) {
            pos[i * 3 + 1] = -500; 
            vel[i] = -0.15 - Math.random() * 0.15;
        }
        geom.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        const pSystem = new THREE.Points(geom, new THREE.PointsMaterial({ color: 0x4fa3ff, size: 0.15, transparent: true, opacity: 0.8 }));
        pSystem.frustumCulled = false;
        scene.add(pSystem);

        // 4. 5초 타이머 로직 변수
        let wateringFrames = 0; 
        const REQUIRED_FRAMES = 300; // 60fps 기준 5초 = 300프레임
        
        const canPos = new THREE.Vector3();
        const flowerPos = new THREE.Vector3();
        const spoutWorldPos = new THREE.Vector3();

        function animate() {
            requestAnimationFrame(animate);
            if (canGroup) {
                canGroup.getWorldPosition(canPos);
                flower.getWorldPosition(flowerPos);
                spoutHelper.getWorldPosition(spoutWorldPos);

                const dist = canPos.distanceTo(flowerPos);

                // [수정] 인식 범위를 좁힘 (기존 7.0 -> 3.8)
                // 꽃 이미지 바로 근처에 가야만 기울어지도록 설정
                if (dist < 3.8) { 
                    isWatering = true; 
                    targetRotZ = -Math.PI / 4; 
                } else if (dist > 4.5) { 
                    isWatering = false; 
                    targetRotZ = 0; 
                }

                // 방향 전환 (꽃을 기준으로 왼쪽/오른쪽)
                if (canPos.x > flowerPos.x) targetRotY = -Math.PI; 
                else targetRotY = 0;

                canGroup.rotation.z = THREE.MathUtils.lerp(canGroup.rotation.z, targetRotZ, 0.1);
                canGroup.rotation.y = THREE.MathUtils.lerp(canGroup.rotation.y, targetRotY, 0.1);

                // 물주기 판정
                const isActuallyWatering = isWatering && canGroup.rotation.z < -0.3;

                if (isActuallyWatering) {
                    wateringFrames++;
                    if (wateringFrames >= REQUIRED_FRAMES) {
                        showFinalResult();
                        return;
                    }
                }

                // 파티클 로직
                const arr = geom.attributes.position.array;
                for (let i = 0; i < count; i++) {
                    if (isActuallyWatering) {
                        if (arr[i * 3 + 1] < -2) {
                            arr[i * 3] = spoutWorldPos.x + (Math.random()-0.5)*0.2;
                            arr[i * 3 + 1] = spoutWorldPos.y;
                            arr[i * 3 + 2] = spoutWorldPos.z + (Math.random()-0.5)*0.2;
                        }
                    }
                    arr[i * 3 + 1] += vel[i];
                    if (arr[i * 3 + 1] < -20) arr[i * 3 + 1] = -500;
                }
                geom.attributes.position.needsUpdate = true;
            }
            renderer.render(scene, camera);
        }
        animate();

        function showFinalResult() {
            document.getElementById('watering-canvas-container').style.display = 'none';
            document.getElementById('final-result').style.display = 'flex';
        }
    </script>
</body>
</html>
